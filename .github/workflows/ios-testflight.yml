name: iOS Build & TestFlight

on:
  push:
    branches: [ main ]

jobs:
  ios:
    runs-on: macos-latest
    env:
      NODE_ENV: development

    steps:
      # 1) Clona tu repo
      - name: 📥 Checkout repository
        uses: actions/checkout@v3

      # 2) Prepara Ruby y cachea gems
      - name: 💎 Set up Ruby & cache gems
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.1.7
          bundler-cache: true

      # 3) Prepara Node y cachea npm
      - name: 🔧 Set up Node.js & cache npm
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      # 4) Instala dependencias JS
      - name: 📦 Install JS dependencies
        run: npm ci

      # 5) Genera el Podspec de react-native-maps
      - name: 🔨 Generate react-native-maps Podspec
        working-directory: ./node_modules/react-native-maps
        run: |
          npm install
          npm run build

      # 6) Cache CocoaPods y ejecuta pod install
      - name: 🧩 Cache CocoaPods
        uses: actions/cache@v3
        with:
          path: |
            ios/Pods
            ~/.cocoapods
          key: ${{ runner.os }}-cocoapods-${{ hashFiles('ios/Podfile.lock') }}

      - name: 🛠️ Install iOS pods
        working-directory: ios
        run: |
          set -o pipefail
          bundle exec pod install --repo-update --verbose

      # 7) Decodifica el certificado de distribución
      - name: 🔑 Decode distribution certificate
        env:
          APPLE_CERT:    ${{ secrets.APPLE_CERTIFICATE }}
          CERT_PASSWORD: ${{ secrets.CERT_PASSWORD }}
        run: |
          echo "$APPLE_CERT" | base64 --decode > ios/ios_distribution.p12
          security create-keychain -p "" build.keychain
          security import ios/ios_distribution.p12 \
            -k ~/Library/Keychains/build.keychain \
            -P "$CERT_PASSWORD" \
            -T /usr/bin/codesign
          security list-keychains -s ~/Library/Keychains/build.keychain

      # 8) Decodifica el provisioning profile
      - name: 📄 Decode provisioning profile
        env:
          PROFILE: ${{ secrets.PROVISIONING_PROFILE }}
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "$PROFILE" | base64 --decode > \
            ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision

      # 9) Decodifica la API Key de App Store Connect
      - name: 🔐 Decode App Store Connect API Key
        env:
          ASC_KEY: ${{ secrets.APPSTORE_API_KEY }}
          KEY_ID:  ${{ secrets.APPSTORE_KEY_ID }}
        run: |
          echo "$ASC_KEY" | base64 --decode > ios/AuthKey_${KEY_ID}.p8

      # 10) Lanza tu lane de Fastlane
      - name: 🚀 Run Fastlane beta
        working-directory: ios
        run: bundle exec fastlane beta
        # fail-fast: false   # <— descomenta si quieres que siga aunque falle Fastlane
