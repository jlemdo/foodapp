name: iOS Build & TestFlight

on:
  push:
    branches: [ main ]

jobs:
  ios:
    runs-on: macos-latest

    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v3

      - name: 💎 Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.1.7

      - name: 📦 Install gems, JS deps & pods
        run: |
          # 1. Instala Bundler y tus gems (incluye fastlane)
          gem install bundler
          bundle config set path vendor/bundle
          bundle install

          # 1b. Fallback: instala cocoapods globalmente
          gem install cocoapods

          # 2. Instala deps de JS
          npm install

          # 3. Limpia Specs cache y fuerza actualización
          rm -rf ~/.cocoapods/repos/trunk
          bundle exec pod repo update

          # 4. Limpia Pods antiguos y reinstala usando el pod global
          rm -rf ios/Pods
          rm -f ios/Podfile.lock
          pushd ios
          pod install --repo-update --verbose
          popd

      - name: 🔑 Decode distribution certificate
        env:
          APPLE_CERT:    ${{ secrets.APPLE_CERTIFICATE }}
          CERT_PASSWORD: ${{ secrets.CERT_PASSWORD }}
        run: |
          echo "$APPLE_CERT" | base64 --decode > ios/ios_distribution.p12
          security create-keychain -p "" build.keychain
          security import ios/ios_distribution.p12 \
            -k ~/Library/Keychains/build.keychain \
            -P "$CERT_PASSWORD" \
            -T /usr/bin/codesign
          security list-keychains -s ~/Library/Keychains/build.keychain

      - name: 📄 Decode provisioning profile
        env:
          PROFILE: ${{ secrets.PROVISIONING_PROFILE }}
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "$PROFILE" | base64 --decode > \
            ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision

      - name: 🔐 Decode App Store Connect API Key
        env:
          ASC_KEY: ${{ secrets.APPSTORE_API_KEY }}
          KEY_ID:  ${{ secrets.APPSTORE_KEY_ID }}
        run: |
          echo "$ASC_KEY" | base64 --decode > AuthKey_${KEY_ID}.p8

      - name: 🚀 Run Fastlane beta lane
        working-directory: ios
        env:
          APPSTORE_KEY_ID:    ${{ secrets.APPSTORE_KEY_ID }}
          APPSTORE_ISSUER_ID: ${{ secrets.APPSTORE_ISSUER_ID }}
          APPSTORE_API_KEY:   ${{ secrets.APPSTORE_API_KEY }}
        run: bundle exec fastlane beta
