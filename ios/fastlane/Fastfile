platform :ios do
  desc "Push a new beta build to TestFlight"
  lane :beta do
    build_app(
      workspace:      "foodapp.xcworkspace",                # o el tuyo
      scheme:         "foodapp",                             # el scheme real
      clean:          true,
      export_method:  "app-store",

      # 1) Establece tu Team
      xcargs:         [
                        "DEVELOPMENT_TEAM=#{ENV['APPLE_TEAM_ID']}",
                        "CODE_SIGN_STYLE=Automatic",
                        "PRODUCT_BUNDLE_IDENTIFIER=#{ENV['APP_IDENTIFIER']}",
                        "PROVISIONING_PROFILE_SPECIFIER=OcrProductos_Release_Profile"
                      ].join(" "),

      # 2) Permite a Xcode actualizar perfiles si hiciera falta
      allowProvisioningUpdates: true,

      # 3) Para el export .ipa
      export_team_id: ENV["APPLE_TEAM_ID"],
      export_options: {
        provisioningProfiles: {
          ENV["APP_IDENTIFIER"] => "OcrProductos_Release_Profile"
        }
      }
    )

    upload_to_testflight
  end
end
